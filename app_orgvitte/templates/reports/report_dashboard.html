{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}–û—Ç—á—ë—Ç–Ω—ã–π –¥–∞—à–±–æ—Ä–¥{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">üìä –û—Ç—á—ë—Ç–Ω—ã–π –¥–∞—à–±–æ—Ä–¥</h2>

    <!-- –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ -->
    <form method="get" class="row g-3 mb-4">
        <div class="col-md-3">
            <label for="start_date" class="form-label">–° –¥–∞—Ç—ã:</label>
            <input type="date" id="start_date" name="start_date" class="form-control" value="{{ start_date }}">
        </div>
        <div class="col-md-3">
            <label for="end_date" class="form-label">–ü–æ –¥–∞—Ç—É:</label>
            <input type="date" id="end_date" name="end_date" class="form-control" value="{{ end_date }}">
        </div>
        <div class="col-md-3 align-self-end">
            <button type="submit" class="btn btn-primary">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
            <a href="{% url 'export_tickets_csv' %}?start_date={{ request.GET.start_date }}&end_date={{ request.GET.end_date }}"
                class="btn btn-outline-success mt-2">üì• –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ CSV</a>
            <a href="{% url 'report_dashboard' %}" class="btn btn-secondary">–°–±—Ä–æ—Å–∏—Ç—å</a>
        </div>
    </form>

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
    <div class="row text-center mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm border-primary">
                <div class="card-body">
                    <h5 class="card-title">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</h5>
                    <p class="display-6 text-primary">{{ total_tickets }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-info">
                <div class="card-body">
                    <h5 class="card-title">–ù–æ–≤—ã–µ</h5>
                    <p class="display-6 text-info">{{ new_tickets }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-warning">
                <div class="card-body">
                    <h5 class="card-title">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</h5>
                    <p class="display-6 text-warning">{{ in_progress_tickets }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-success">
                <div class="card-body">
                    <h5 class="card-title">–ó–∞–∫—Ä—ã—Ç–æ</h5>
                    <p class="display-6 text-success">{{ done_tickets }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <h5>üìà –î–∏–Ω–∞–º–∏–∫–∞ –∑–∞—è–≤–æ–∫ –ø–æ –º–µ—Å—è—Ü–∞–º</h5>
            <canvas id="ticketsByMonthChart"></canvas>
        </div>
        <div class="col-md-6 mb-4">
            <h5>üèÜ –¢–û–ü-5 –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h5>
            <canvas id="topEquipmentChart"></canvas>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6 mb-4">
            <h5>üë∑ –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ç–µ—Ö–Ω–∏–∫–æ–≤</h5>
            <canvas id="ticketsByTechChart"></canvas>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // –î–∏–Ω–∞–º–∏–∫–∞ –∑–∞—è–≤–æ–∫ –ø–æ –º–µ—Å—è—Ü–∞–º
    const ticketsByMonthCtx = document.getElementById('ticketsByMonthChart');
    new Chart(ticketsByMonthCtx, {
        type: 'line',
        data: {
            labels: {{ months|safe }},
            datasets: [{
                label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—è–≤–æ–∫',
                data: {{ month_counts|safe }},
                borderColor: 'blue',
                backgroundColor: 'rgba(0,123,255,0.2)',
                fill: true,
                tension: 0.3
            }]
        }
    });

    // –¢–û–ü-5 –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
    const topEquipmentCtx = document.getElementById('topEquipmentChart');
    new Chart(topEquipmentCtx, {
        type: 'bar',
        data: {
            labels: {{ equipment_labels|safe }},
            datasets: [{
                label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—è–≤–æ–∫',
                data: {{ equipment_counts|safe }},
                backgroundColor: 'rgba(255,99,132,0.6)',
                borderColor: 'rgb(255,99,132)',
                borderWidth: 1
            }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
    });

    // –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ç–µ—Ö–Ω–∏–∫–æ–≤
    const ticketsByTechCtx = document.getElementById('ticketsByTechChart');
    new Chart(ticketsByTechCtx, {
        type: 'pie',
        data: {
            labels: {{ tech_labels|safe }},
            datasets: [{
                label: '–ó–∞–∫—Ä—ã—Ç—ã–µ –∑–∞—è–≤–∫–∏',
                data: {{ tech_counts|safe }},
                backgroundColor: [
                    'rgba(54,162,235,0.6)',
                    'rgba(255,206,86,0.6)',
                    'rgba(75,192,192,0.6)',
                    'rgba(153,102,255,0.6)',
                    'rgba(255,159,64,0.6)'
                ]
            }]
        }
    });
</script>
{% endblock %}

