{% extends 'base.html' %}

{% block title %}Отчёт по заявкам{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4 text-center">Отчёт по заявкам (за последние 30 дней)</h2>

    <!-- Таблица 1: по типам заявок -->
    <h4>Количество заявок по типам</h4>
    <table class="table table-bordered table-striped shadow-sm">
        <thead class="table-dark">
            <tr>
                <th>Тип заявки</th>
                <th>Количество</th>
            </tr>
        </thead>
        <tbody>
        {% for item in stats %}
            <tr>
                <td>{{ item.request_type_display }}</td>
                <td>{{ item.total }}</td>
            </tr>
        {% empty %}
            <tr>
                <td colspan="2" class="text-center text-muted">Нет данных</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <!-- Таблица 2: по статусам -->
    <h4 class="mt-5">Заявки по статусам</h4>
    <table class="table table-bordered table-striped shadow-sm">
        <thead class="table-dark">
            <tr>
                <th>Статус</th>
                <th>Количество</th>
            </tr>
        </thead>
        <tbody>
        {% for row in tickets_by_status %}
            <tr>
                <td>{{ row.status_display }}</td>
                <td>{{ row.count }}</td>
            </tr>
        {% empty %}
            <tr>
                <td colspan="2" class="text-center text-muted">Нет данных</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <!-- Таблица 3: по техникам (выполненные заявки) -->
    <h4 class="mt-5">Выполненные заявки по техникам</h4>
    <table class="table table-bordered table-striped shadow-sm">
        <thead class="table-dark">
            <tr>
                <th>Техник</th>
                <th>Количество выполненных заявок</th>
            </tr>
        </thead>
        <tbody>
        {% for tech in tickets_by_tech %}
            <tr>
                <td>{{ tech.assigned_to__username|default:"Не назначен" }}</td>
                <td>{{ tech.count }}</td>
            </tr>
        {% empty %}
            <tr>
                <td colspan="2" class="text-center text-muted">Нет данных</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <div class="mt-4 text-center">
    {% if user.role == "admin" %}
        <a href="{% url 'admin_dashboard' %}" class="btn btn-secondary">⬅ Назад в панель администратора</a>
    {% elif user.role == "tech" %}
        <a href="{% url 'tech_dashboard' %}" class="btn btn-secondary">⬅ Назад в панель техника</a>
    {% else %}
        <a href="{% url 'user_dashboard' %}" class="btn btn-secondary">⬅ Назад</a>
    {% endif %}
    </div>
</div>
{% endblock %}
